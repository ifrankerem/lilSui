name: Deploy to Walrus Sites

on:
  push:
    branches: [final]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node. js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Fix asset paths for Walrus
        working-directory: ./frontend
        run: |
          sed -i 's|"/assets|"./assets|g' dist/index.html
          sed -i 's|"/vite|"./vite|g' dist/index.html
          echo "=== index.html content ==="
          cat dist/index.html
      
      - name: Install Walrus CLI
        run: |
          curl -L "https://storage.googleapis.com/mysten-walrus-binaries/walrus-testnet-latest-ubuntu-x86_64" -o walrus
          chmod +x walrus
          sudo mv walrus /usr/local/bin/
          walrus --version
      
      - name: Install Site Builder
        run: |
          curl -L "https://storage.googleapis.com/mysten-walrus-binaries/site-builder-testnet-latest-ubuntu-x86_64" -o site-builder
          chmod +x site-builder
          sudo mv site-builder /usr/local/bin/
          site-builder --version
      
      - name: Setup Sui Wallet
        env:
          SUI_PRIVATE_KEY: ${{ secrets.SUI_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.sui/sui_config
          echo "[\"$SUI_PRIVATE_KEY\"]" > ~/.sui/sui_config/sui.keystore
          cat > ~/.sui/sui_config/client.yaml << 'EOF'
          ---
          keystore:
            File: /home/runner/.sui/sui_config/sui.keystore
          envs:
            - alias: testnet
              rpc: "https://fullnode.testnet.sui.io:443"
          active_env: testnet
          active_address: "0xea8ae94f8ff05578afe1ec7d5b55f30d864bf1f8411a39fe597fd755dbbfc41d"
          EOF
          echo "Sui wallet configured"
      
      - name: Setup Walrus Config
        run: |
          mkdir -p ~/.config/walrus
          cat > ~/.config/walrus/client_config.yaml << 'EOF'
          system_object: 0x6c2547cbbc38025cf3adac45f63cb0a8d12ecf777cdc75a4971612bf97fdf6af
          staking_object: 0xbe46180321c30aab2f8b3501e24048377287fa708018a5b7c2792b35fe339ee3
          exchange_objects:
            - 0xf4d164ea2def5fe07dc573992a029e010dba09b1a8dcbc44c5c2e79567f39073
            - 0x19825121c52080bb1073662231cfea5c0e4d905fd13e95f21e9a018f2ef41862
            - 0x83b454e524c71f30803f4d6c302a86fb6a39e96cdfb873c2d1e93bc1c26a3bc5
            - 0x8d63209cf8589ce7aef8f262437163c67577ed09f3e636a9d8e0813843fb8bf1
          rpc_url: https://fullnode.testnet.sui.io:443
          EOF
          cat > ~/.config/walrus/sites-config.yaml << 'EOF'
          portal: "trwal.app"
          package: "0xf99aee9f21493e1590e7e5a9aea6f343a1f381031a04a732724871fc294be799"
          general:
            rpc_url: "https://fullnode.testnet.sui.io:443"
            wallet_env: "testnet"
            walrus_binary: "walrus"
            walrus_config: "/home/runner/.config/walrus/client_config.yaml"
            gas_budget: 500000000
          staking_object: "0xbe46180321c30aab2f8b3501e24048377287fa708018a5b7c2792b35fe339ee3"
      - name: Deploy to Walrus
        working-directory: ./frontend
        run: |
          echo "=== Starting Walrus Deploy ==="
          site-builder --config ~/.config/walrus/sites-config.yaml publish --epochs 10 --site-name Agora ./dist